<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMB Campaign Creator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font and professional colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Updated to a more vibrant blue
                        'primary-dark': '#3B82F6', 
                        'secondary-light': '#F9FAFB', 
                        'accent-green': '#10B981',
                        'text-base': '#1F2937',
                        // Status Colors for clarity
                        'status-success': '#059669',
                        'status-warning': '#D97706',
                        'status-error': '#DC2626',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        .step-indicator {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .step-indicator.active {
            font-weight: 800; /* Extra bold for active step */
            color: var(--primary-dark);
            border-bottom: 3px solid var(--primary-dark);
        }
        .step-card {
            min-height: 400px;
        }
        /* Custom styling for inputs/selects */
        .app-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.15s ease;
        }
        .app-input:focus {
            border-color: var(--primary-dark);
            outline: none;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.25); /* Richer focus glow */
        }
    </style>
</head>
<body class="bg-secondary-light font-sans text-text-base">

    <!-- Mock Firebase Init -->
    <script type="module">
        // Basic mock setup for Firebase global variables (required by instructions)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { projectId: "mock-project" };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        console.log("Firebase setup variables initialized (mocking).");
    </script>

    <!-- Header & Login -->
    <header class="shadow-lg bg-white z-10 sticky top-0">
        <div class="max-w-3xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-extrabold text-primary-dark tracking-wide">
                CAMPAIGN LAUNCHPAD
            </h1>
            <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-500 hidden sm:inline">Hello, Merchant</span>
                <!-- Login Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary-dark cursor-pointer hover:text-blue-700 transition duration-150" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-10">
        
        <!-- Step Navigation Bar -->
        <div id="step-nav" class="flex justify-between border-b-4 border-gray-100 mb-8 pb-3 bg-white p-4 rounded-xl shadow-xl">
            <div id="nav-step-1" class="step-indicator active flex-1 text-center py-1 text-sm text-gray-500" onclick="navigate(1)">1. Goal & Persona</div>
            <div id="nav-step-2" class="step-indicator flex-1 text-center py-1 text-sm text-gray-500" onclick="navigate(2)">2. Playbook & Geo</div>
            <div id="nav-step-3" class="step-indicator flex-1 text-center py-1 text-sm text-gray-500" onclick="navigate(3)">3. Creative Lite</div>
            <div id="nav-step-4" class="step-indicator flex-1 text-center py-1 text-sm text-gray-500" onclick="navigate(4)">4. Budget & Guardrails</div>
            <!-- Note: Steps 5 and 6 are post-creation views -->
        </div>

        <!-- Main Content Area -->
        <div id="content-area" class="bg-white rounded-xl shadow-2xl p-6 sm:p-8 border-t-4 border-primary-dark step-card">
            <!-- Content will be rendered here by JavaScript -->
        </div>

        <!-- Navigation Buttons -->
        <div id="nav-controls" class="flex justify-between mt-8 max-w-sm mx-auto">
            <button id="back-btn" onclick="goBack()" class="px-6 py-2 border border-gray-400 text-gray-700 rounded-lg hover:bg-gray-100 transition duration-150 shadow-md disabled:opacity-50" disabled>
                <span class="font-semibold">‚Üê Back</span>
            </button>
            <button id="next-btn" onclick="goNext()" class="px-8 py-3 bg-primary-dark text-white font-extrabold rounded-lg hover:bg-blue-600 transition duration-150 shadow-xl disabled:opacity-50 disabled:shadow-md">
                Next
            </button>
        </div>
    </main>

    <!-- JavaScript Application Logic -->
    <script>
        const CREATION_STEPS = 4; // Max step for campaign creation
        let currentStep = 1;
        
        // --- Core Application State ---
        const appState = {
            step: 1,
            persona: null,
            personaOther: '',
            goal: null,
            goalOther: '',
            playbook: null,
            budget: 5000,
            cpaStop: true,
            radius: 3,
            headline: '',
            body: '',
            expectedOutcomeText: '',
            expectedCPA: 0,
            cpaLow: 0,
            cpaHigh: 0,
            outcomeLabel: 'Action'
        };

        const PERSONAS = {
            PRIYA: { name: "Priya, Quick-Service Operator (Cafe)", type: "Quick-Service", defaultGoal: "Walk-ins" },
            ROHAN: { name: "Rohan, Capital-Sensitive Merchant (Retail)", type: "Capital-Sensitive", defaultGoal: "Calls" },
            SAMEERA: { name: "Sameera, High-Touch Service (Jeweler)", type: "High-Touch Service", defaultGoal: "Event RSVP" },
            OTHER: { name: "Other / Not listed" }
        };

        const GOALS = {
            WALKINS: { name: "Walk-ins / Foot Traffic" },
            CALLS: { name: "Direct Calls / Inquiries" },
            WHATSAPP: { name: "WhatsApp orders / Chat Leads" },
            RSVP: { name: "Event RSVP / Booking" },
            OTHER: { name: "Other Goal" }
        };

        const PLAYBOOKS = [
            { id: 'sale', name: "Festival Sale (Clearance)", isContextual: false },
            { id: 'event', name: "Event Booster (High-Value Leads)", isContextual: false },
            { id: 'delivery', name: "Rainy-Day Delivery (Weather Triggered)", isContextual: true },
            { id: 'product', name: "New Product Launch", isContextual: false },
        ];

        // --- Utility Functions ---

        function updateUIControls() {
            // Update Step Nav appearance
            document.querySelectorAll('.step-indicator').forEach((el, index) => {
                el.classList.remove('active', 'text-text-base');
                el.classList.add('text-gray-500');
                if (index + 1 === currentStep) {
                    el.classList.add('active', 'text-primary-dark');
                }
            });

            // Update Navigation Buttons
            const backBtn = document.getElementById('back-btn');
            const nextBtn = document.getElementById('next-btn');
            
            backBtn.disabled = currentStep === 1;

            // Handle button visibility and text for post-creation steps
            if (currentStep > CREATION_STEPS) {
                backBtn.style.display = 'inline-block';
                nextBtn.style.display = 'none';
            } else {
                backBtn.style.display = 'inline-block';
                nextBtn.style.display = 'inline-block';
                nextBtn.disabled = !isStepComplete(currentStep);
                nextBtn.textContent = currentStep === CREATION_STEPS ? 'Publish Campaign' : 'Next';
            }
        }

        function isStepComplete(step) {
            switch (step) {
                case 1:
                    if (!appState.persona || !appState.goal) return false;
                    
                    if (appState.persona === 'OTHER' && appState.personaOther.trim() === '') return false;
                    if (appState.goal === 'OTHER' && appState.goalOther.trim() === '') return false;
                    
                    return true;
                case 2:
                    return appState.playbook !== null;
                case 3:
                    // Creative Studio Lite
                    return appState.headline.trim() !== '' && appState.body.trim() !== '';
                case 4:
                    // Budget and Guardrails
                    return true;
                default:
                    return true; 
            }
        }

        function navigate(step) {
            if (step < 1 || step > 6) return;
            // Only allow navigating backwards to a step in the creation flow (1-4)
            if (step <= CREATION_STEPS && step > currentStep && !isStepComplete(currentStep)) {
                console.warn(`Cannot navigate to step ${step}: Current step is incomplete.`);
                return;
            }
            
            currentStep = step;

            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '';
            
            switch (currentStep) {
                case 1:
                    renderStep1Goal(contentArea);
                    break;
                case 2:
                    renderStep2Playbook(contentArea);
                    break;
                case 3:
                    renderStep3Creative(contentArea);
                    break;
                case 4:
                    renderStep4Budget(contentArea);
                    break;
                case 5:
                    renderDashboard(contentArea);
                    break;
                case 6:
                    renderHistoricalDashboard(contentArea);
                    break;
            }

            updateUIControls();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goBack() {
            if (currentStep > 1) {
                navigate(currentStep - 1);
            }
        }

        function goNext() {
            if (currentStep <= CREATION_STEPS && isStepComplete(currentStep)) {
                // If moving from step 3 to 4, save final creative
                if (currentStep === 3) {
                    appState.headline = document.getElementById('headline-input').value;
                    appState.body = document.getElementById('body-input').value;
                }
                // Before moving to step 5 (Dashboard), calculate and store expected outcomes
                if (currentStep === 4) {
                    calculateExpectedOutcomes();
                }

                navigate(currentStep + 1);
            }
        }

        // Reusable CPA calculation logic
        function calculateExpectedOutcomes() {
            const personaKey = appState.persona;
            const goalKey = appState.goal;
            const personaType = PERSONAS[personaKey]?.type || 'Standard';
            
            let cpaRange = [15, 30]; // Default medium
            appState.outcomeLabel = GOALS[goalKey]?.name || 'Action';
            
            if (goalKey === 'RSVP' || goalKey === 'CALLS') {
                cpaRange = [40, 90]; // Higher CPA for higher intent leads
            } else if (goalKey === 'WHATSAPP' && personaType === 'Quick-Service') {
                cpaRange = [8, 20]; // Lower CPA for high-volume chat/delivery orders
            }

            appState.cpaLow = cpaRange[0];
            appState.cpaHigh = cpaRange[1];

            const lowOutcome = Math.floor(appState.budget / appState.cpaHigh);
            const highOutcome = Math.floor(appState.budget / appState.cpaLow);
            
            appState.expectedOutcomeText = `${lowOutcome} - ${highOutcome} ${appState.outcomeLabel}`;
            // Use the average of the range as the expected CPA
            appState.expectedCPA = Math.floor((appState.cpaLow + appState.cpaHigh) / 2); 
        }


        // --- Step 1: Goal & Persona ---

        function handlePersonaChange(value) {
            appState.persona = value;
            document.getElementById('other-persona-input').style.display = value === 'OTHER' ? 'block' : 'none';
            if (value === 'OTHER') {
                appState.personaOther = document.getElementById('persona-other-text').value;
            } else {
                appState.personaOther = '';
            }
            updateUIControls();
        }

        function handleGoalChange(value) {
            appState.goal = value;
            document.getElementById('other-goal-input').style.display = value === 'OTHER' ? 'block' : 'none';
            if (value === 'OTHER') {
                appState.goalOther = document.getElementById('goal-other-text').value;
            } else {
                appState.goalOther = '';
            }
            updateUIControls();
        }

        function renderStep1Goal(container) {
            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-primary-dark">Step 1: Define Business & Goal</h2>
                <p class="text-gray-600 mb-8">Select your business type and the single outcome you want to track. This simplifies targeting for you.</p>
                
                <div class="space-y-6">
                    <!-- Persona Selection -->
                    <div>
                        <label for="persona-select" class="block text-lg font-semibold mb-2">1A. Select Your Business Persona</label>
                        <select id="persona-select" class="app-input" onchange="handlePersonaChange(this.value)">
                            <option value="" disabled ${appState.persona === null ? 'selected' : ''}>-- Select a Persona --</option>
                            ${Object.keys(PERSONAS).map(key => `<option value="${key}" ${appState.persona === key ? 'selected' : ''}>${PERSONAS[key].name}</option>`).join('')}
                        </select>
                        <div id="other-persona-input" class="mt-4 ${appState.persona === 'OTHER' ? 'block' : 'hidden'}">
                            <input type="text" id="persona-other-text" placeholder="e.g., Fitness Studio, Dental Clinic" class="app-input" value="${appState.personaOther}" oninput="appState.personaOther = this.value; updateUIControls()">
                            <p class="text-xs text-gray-500 mt-1">Please specify your business type.</p>
                        </div>
                    </div>

                    <!-- Goal Selection -->
                    <div class="pt-4 border-t border-gray-100">
                        <label for="goal-select" class="block text-lg font-semibold mb-2">1B. Select Your Primary Campaign Goal</label>
                        <select id="goal-select" class="app-input" onchange="handleGoalChange(this.value)">
                            <option value="" disabled ${appState.goal === null ? 'selected' : ''}>-- Select a Goal --</option>
                            ${Object.keys(GOALS).map(key => `<option value="${key}" ${appState.goal === key ? 'selected' : ''}>${GOALS[key].name}</option>`).join('')}
                        </select>
                        <div id="other-goal-input" class="mt-4 ${appState.goal === 'OTHER' ? 'block' : 'hidden'}">
                            <input type="text" id="goal-other-text" placeholder="e.g., App Downloads, Newsletter Signups" class="app-input" value="${appState.goalOther}" oninput="appState.goalOther = this.value; updateUIControls()">
                            <p class="text-xs text-gray-500 mt-1">Please specify your desired outcome.</p>
                        </div>
                    </div>
                </div>
            `;
            updateUIControls();
        }

        // --- Step 2: Playbook & Geo ---

        function handlePlaybookChange(value) {
            appState.playbook = value;
            updateUIControls();
        }

        function renderStep2Playbook(container) {
            const selectedPersona = PERSONAS[appState.persona]?.name || appState.personaOther;
            const selectedGoal = GOALS[appState.goal]?.name || appState.goalOther;

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-primary-dark">Step 2: Playbook & Geo-Targeting</h2>
                <p class="text-gray-600 mb-8">The Playbook pre-configures technical settings (channels, bidding) based on your needs.</p>
                
                <div class="space-y-6">
                    <!-- Playbook Selection -->
                    <div>
                        <label for="playbook-select" class="block text-lg font-semibold mb-2">2A. Choose Campaign Playbook</label>
                        <select id="playbook-select" class="app-input" onchange="handlePlaybookChange(this.value)">
                            <option value="" disabled ${appState.playbook === null ? 'selected' : ''}>-- Select a Playbook --</option>
                            ${PLAYBOOKS.map(p => {
                                const isRecommended = (p.id === 'delivery' && appState.persona === 'PRIYA') || (p.id === 'event' && appState.persona === 'SAMEERA');
                                return `<option value="${p.id}" ${appState.playbook === p.id ? 'selected' : ''}>${p.name} ${isRecommended ? '(Recommended)' : ''}</option>`;
                            }).join('')}
                        </select>
                        <p class="text-sm text-gray-500 mt-2">Selected: <span class="font-medium">${selectedPersona}</span> targeting <span class="font-medium">${selectedGoal}</span>.</p>
                        ${appState.playbook === 'delivery' ? '<p class="text-sm text-primary-dark mt-1 font-extrabold">‚ö° Smart Automation: This Playbook includes the Weather-Lite Trigger.</p>' : ''}
                    </div>

                    <!-- Geo-Targeting -->
                    <div class="pt-4 border-t border-gray-100">
                        <label for="radius-slider" class="block text-lg font-semibold mb-2">2B. Set Hyperlocal Radius (Geo-Fence)</label>
                        <p class="text-sm text-gray-500 mb-4">We target relevant users within a <span id="radius-value" class="font-bold text-primary-dark">${appState.radius}</span> km radius from your business Pincode (e.g., 500033).</p>
                        <input type="range" id="radius-slider" min="1" max="10" step="1" value="${appState.radius}" oninput="appState.radius = parseInt(this.value); document.getElementById('radius-value').textContent = this.value; updateUIControls()" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-500 mt-2">
                            <span>1 km (Very Local)</span>
                            <span>10 km (Wider Reach)</span>
                        </div>
                    </div>
                </div>
            `;
            updateUIControls();
        }

        // --- Step 3: Creative Studio Lite ---
        
        function getTrackingExplanation(playbookId, goalKey) {
            if (playbookId === 'delivery' && goalKey === 'WALKINS') {
                return {
                    title: "Walk-in Tracking Mechanism Active",
                    text: "Since this is a contextual campaign, 'Walk-ins' are tracked by requiring the user to **Claim a unique QR Pass** on the landing page after clicking the ad. The merchant scans this code at the counter to confirm the successful visit and measure CPA.",
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 4l-4 4 4 4" /></svg>` 
                };
            }
            if (playbookId === 'event' && goalKey === 'RSVP') {
                return {
                    title: "Event RSVP Tracking Mechanism Active",
                    text: "'Event RSVP' is measured when the user **generates a trackable e-ticket/QR code**. This minimizes fraud and provides a clear conversion signal for high-value leads.",
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2v-2z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.894 10.742L13.568 3.416a2 2 0 00-2.828 0L3.416 10.742A2 2 0 003 12.156v4.688A2.121 2.121 0 005.121 19h1.758a.707.707 0 00.707-.707V15a.707.707 0 01.707-.707h1.758a.707.707 0 01.707.707v3.293a.707.707 0 00.707.707h1.758a2.121 2.121 0 002.121-2.121v-4.688a2 2 0 00-.006-1.414z" /></svg>` 
                };
            }
            return null;
        }

        function generateMockCreative(personaKey, playbookId) {
            const personaName = PERSONAS[personaKey]?.name.split(',')[0] || 'Local Business';
            const playbookName = PLAYBOOKS.find(p => p.id === playbookId)?.name || 'New Offer';
            
            let headline = "";
            let body = "";

            if (playbookId === 'delivery') {
                headline = "‚òî Raining? Claim Your Free Hot Beverage!";
                body = `The ${personaName} Rainy Day Playbook is active! Click now to claim your trackable QR Pass for a free hot drink on your visit. We'll track this as a Walk-in.`;
            } else if (playbookId === 'event') {
                 headline = "üíé Private Viewing: High-Value Event RSVP";
                 body = `Join ${personaName} for an exclusive event. Secure your spot and trackable QR Pass instantly. Goal: Tracked RSVP.`;
            } else {
                 headline = `${personaName}: ${playbookName} Now Live!`;
                 body = `Don't miss out on local deals! Our sale is running for 48 hours only. Click to call and verify product availability.`;
            }
            
            appState.headline = headline;
            appState.body = body;
        }

        function renderStep3Creative(container) {
            if (appState.headline === '' || appState.body === '') {
                generateMockCreative(appState.persona, appState.playbook);
            }

            const trackingInfo = getTrackingExplanation(appState.playbook, appState.goal);
            let trackingBox = '';

            if (trackingInfo) {
                // Enhanced color for tracking explanation box
                trackingBox = `
                    <div class="flex items-start p-4 mb-8 bg-primary-dark rounded-xl border border-primary-dark/80 shadow-lg text-white">
                        <div class="flex-shrink-0 mr-3">${trackingInfo.icon}</div>
                        <div>
                            <p class="font-extrabold">${trackingInfo.title}</p>
                            <p class="text-sm mt-1">${trackingInfo.text}</p>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-primary-dark">Step 3: Creative Studio Lite</h2>
                <p class="text-gray-600 mb-8">Your copy is auto-generated based on the Playbook. Make any necessary offer edits below. </p>

                ${trackingBox}

                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Copy Editing Area -->
                    <div class="space-y-6">
                        <div>
                            <label for="headline-input" class="block text-sm font-medium text-gray-700 mb-1">Headline (Max 30 chars)</label>
                            <input type="text" id="headline-input" value="${appState.headline}" oninput="document.getElementById('preview-headline').textContent = this.value; appState.headline = this.value; updateUIControls()" class="app-input" maxlength="30">
                        </div>
                        <div>
                            <label for="body-input" class="block text-sm font-medium text-gray-700 mb-1">Body Text (Max 90 chars)</label>
                            <textarea id="body-input" rows="4" oninput="document.getElementById('preview-body').textContent = this.value; appState.body = this.value; updateUIControls()" class="app-input" maxlength="90">${appState.body}</textarea>
                        </div>
                        <div class="pt-4 border-t border-gray-100">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Language Toggle</label>
                            <div class="flex space-x-3">
                                <button class="px-4 py-2 bg-primary-dark text-white font-semibold rounded-lg text-sm shadow-md">English</button>
                                <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition duration-150">Local Language (Draft)</button>
                            </div>
                        </div>
                    </div>

                    <!-- Ad Preview Mock -->
                    <div class="p-4 bg-secondary-light rounded-xl shadow-inner border border-gray-300">
                        <h3 class="font-bold mb-3 text-sm text-gray-700">Multi-Channel Ad Preview</h3>
                        <div class="w-full bg-white border border-gray-300 rounded-lg p-3 shadow-xl">
                            <div class="flex items-center mb-2">
                                <div class="w-7 h-7 bg-primary-dark rounded-full mr-2"></div>
                                <div>
                                    <p class="font-semibold text-xs">${PERSONAS[appState.persona]?.name.split(',')[0]}'s Store</p>
                                    <p class="text-[10px] text-gray-500">Sponsored Post</p>
                                </div>
                            </div>
                            <img src="https://placehold.co/400x180/E5E7EB/4B5563?text=${PLAYBOOKS.find(p => p.id === appState.playbook).name.replace(/\s/g, '+')}" class="w-full h-auto rounded-lg mb-3" alt="Mock Ad Creative">
                            <p class="font-extrabold text-sm mb-1 text-primary-dark" id="preview-headline">${appState.headline}</p>
                            <p class="text-xs text-gray-700 mb-3" id="preview-body">${appState.body}</p>
                            <button class="w-full bg-accent-green text-white py-2 rounded-lg font-extrabold text-xs shadow-md hover:bg-green-600 transition duration-150">CTA: ${GOALS[appState.goal]?.name || appState.goalOther}</button>
                        </div>
                    </div>
                </div>
            `;
            updateUIControls();
        }

        // --- Step 4: Budget & Guardrails ---

        function updateBudget(newBudget) {
            appState.budget = parseInt(newBudget);
            calculateExpectedOutcomes();
            renderStep4Budget(document.getElementById('content-area'));
        }

        function renderStep4Budget(container) {
            calculateExpectedOutcomes();

            const personaType = PERSONAS[appState.persona]?.type || 'Standard';

            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-primary-dark">Step 4: Budget & Guardrails</h2>
                <p class="text-gray-600 mb-8">Set your budget and ensure your financial safeguards are active. (P1: Trust Engine)</p>

                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Budget Slider & Simulator -->
                    <div>
                        <label class="block text-lg font-semibold mb-4">4A. Total Campaign Budget (‚Çπ)</label>
                        <input type="range" id="budget-slider" min="2000" max="20000" step="1000" value="${appState.budget}" oninput="updateBudget(this.value)" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
                        
                        <div class="flex justify-between text-sm text-gray-500 mt-2">
                            <span>‚Çπ2,000</span>
                            <span>‚Çπ20,000</span>
                        </div>

                        <div class="mt-8 p-6 bg-primary-dark/10 rounded-xl border-l-4 border-primary-dark shadow-lg">
                            <h3 class="text-lg font-extrabold text-primary-dark mb-2">Budget Confidence Simulator</h3>
                            <p class="text-5xl font-extrabold text-text-base" id="budget-display">‚Çπ${appState.budget.toLocaleString()}</p>
                            <p class="text-sm text-gray-700 mt-3">Estimated outcomes based on **${personaType}** historical data:</p>
                            <p class="text-xl font-bold mt-2 text-primary-dark" id="outcome-display">${appState.expectedOutcomeText}</p>
                        </div>
                    </div>

                    <!-- Guardrails & Auto-Expiry -->
                    <div class="space-y-6">
                        <label class="block text-lg font-semibold mb-4">4B. Mandatory Financial Guardrails</label>
                        
                        <!-- Auto-Pause on High CPA -->
                        <div class="bg-red-50 p-4 rounded-lg border-2 border-red-300 shadow-md">
                            <div class="flex items-center justify-between">
                                <span class="font-bold text-status-error">Auto-Pause on High CPA</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="cpa-guardrail" checked disabled class="sr-only peer">
                                    <div class="w-11 h-6 bg-red-400 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent-green"></div>
                                </label>
                            </div>
                            <p class="text-sm text-gray-700 mt-2">Campaign **automatically pauses** if Cost-per-Action (CPA) exceeds a profitable limit (default: ‚Çπ${appState.cpaLow + 10}).</p>
                            <p class="text-xs text-status-error mt-2 font-extrabold">MANDATORY safety net (P1 solution).</p>
                        </div>

                        <!-- Auto-Expiry -->
                        <div class="bg-secondary-light p-4 rounded-lg border border-gray-300 shadow-md">
                            <div class="flex items-center justify-between">
                                <span class="font-bold">Auto-Expiry Date</span>
                                <input type="date" value="2025-10-10" class="p-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                            <p class="text-sm text-gray-500 mt-2">Prevents continuous surprise billing by setting a fixed end date.</p>
                        </div>
                    </div>
                </div>
            `;
            updateUIControls();
        }

        // --- Step 5: Dashboard (Campaign Published / Expected Outcomes) ---

        function renderDashboard(container) {
            const playbookName = PLAYBOOKS.find(p => p.id === appState.playbook)?.name;

            container.innerHTML = `
                <div class="max-w-2xl mx-auto text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-accent-green mx-auto mb-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586l-1.793-1.793a1 1 0 00-1.414 1.414l2.5 2.5a1 1 0 001.414 0l4.5-4.5z" clip-rule="evenodd" />
                    </svg>
                    <h2 class="text-3xl font-extrabold mb-4 text-accent-green">Campaign Published!</h2>
                    <p class="text-lg text-gray-600 mb-10">Your **${playbookName}** is live and protected by financial guardrails. Here are your expected outcomes.</p>

                    <h3 class="text-xl font-bold mb-5 text-primary-dark border-b pb-2">Expected Outcome Metrics</h3>

                    <div class="grid md:grid-cols-3 gap-4 mb-8">
                        <!-- Metric 1: Budget -->
                        <div class="p-4 bg-primary-dark/10 rounded-xl shadow-md border-l-4 border-primary-dark">
                            <p class="text-3xl font-extrabold text-primary-dark">‚Çπ${appState.budget.toLocaleString()}</p>
                            <p class="text-sm text-gray-600 mt-1">Total Budget</p>
                        </div>
                        <!-- Metric 2: Expected Outcomes Range -->
                        <div class="p-4 bg-primary-dark/10 rounded-xl shadow-md border-l-4 border-primary-dark">
                            <p class="text-3xl font-extrabold text-primary-dark">${appState.expectedOutcomeText.split(' ')[0]}</p>
                            <p class="text-sm text-gray-600 mt-1">Expected ${appState.outcomeLabel}</p>
                        </div>
                        <!-- Metric 3: Expected CPA -->
                        <div class="p-4 bg-primary-dark/10 rounded-xl shadow-md border-l-4 border-primary-dark">
                            <p class="text-3xl font-extrabold text-primary-dark">~‚Çπ${appState.expectedCPA}</p>
                            <p class="text-sm text-gray-600 mt-1">Expected CPA</p>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-accent-green text-white rounded-xl mb-10 shadow-xl">
                        <h4 class="text-lg font-extrabold mb-1">Success Guardrail Active</h4>
                        <p class="text-sm">The campaign will **auto-pause** if the actual Cost-per-Action exceeds **‚Çπ${appState.cpaLow + 10}**, ensuring you never overpay.</p>
                    </div>

                    <a href="#" onclick="navigate(6)" class="inline-block px-8 py-3 bg-primary-dark text-white font-extrabold rounded-lg hover:bg-blue-600 transition duration-150 shadow-xl">
                        Track Older Campaigns (Historical Data)
                    </a>
                </div>
            `;
            updateUIControls();
        }

        // --- Step 6: Historical Dashboard (New color emphasis) ---

        function renderHistoricalDashboard(container) {
            container.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-primary-dark">Step 6: Historical Campaign Performance</h2>
                <p class="text-gray-600 mb-8">View the performance and efficiency of your previous campaigns to optimize future strategies.</p>

                <div class="space-y-6">
                    <!-- Campaign 1: Rainy-Day Delivery (Successful - Green Theme) -->
                    <div class="p-5 bg-green-50 rounded-xl border-2 border-status-success shadow-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-extrabold text-status-success">Campaign A: Rainy-Day Delivery (Q3 2024)</h3>
                            <span class="text-sm font-semibold text-white px-3 py-1 bg-status-success rounded-full shadow-md">Completed</span>
                        </div>
                        <p class="text-sm text-gray-700 mb-3">Goal: Walk-ins. Triggered on 12 rainy days in a 2km radius.</p>
                        <div class="grid grid-cols-3 gap-3 text-center pt-3 border-t border-green-200">
                            <div><p class="text-2xl font-extrabold text-text-base">‚Çπ3,500</p><p class="text-xs text-gray-500">Total Spent</p></div>
                            <div><p class="text-2xl font-extrabold text-text-base">140</p><p class="text-xs text-gray-500">Walk-ins (Scans)</p></div>
                            <div><p class="text-2xl font-extrabold text-status-success">‚Çπ25</p><p class="text-xs text-gray-500">Actual CPA (Efficient)</p></div>
                        </div>
                    </div>

                    <!-- Campaign 2: Festival Sale (High CPA - Red Theme) -->
                    <div class="p-5 bg-red-50 rounded-xl border-2 border-status-error shadow-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-extrabold text-status-error">Campaign B: Festival Sale (Q2 2024)</h3>
                            <span class="text-sm font-semibold text-white px-3 py-1 bg-status-error rounded-full shadow-md">Auto-Paused</span>
                        </div>
                        <p class="text-sm text-gray-700 mb-3">Goal: Calls. Ran for 7 days before guardrail triggered.</p>
                        <div class="grid grid-cols-3 gap-3 text-center pt-3 border-t border-red-200">
                            <div><p class="text-2xl font-extrabold text-text-base">‚Çπ4,800</p><p class="text-xs text-gray-500">Total Spent</p></div>
                            <div><p class="text-2xl font-extrabold text-text-base">53</p><p class="text-xs text-gray-500">Total Calls</p></div>
                            <div><p class="text-2xl font-extrabold text-status-error">‚Çπ90</p><p class="text-xs text-gray-500">Final CPA (High)</p></div>
                        </div>
                    </div>
                    
                    <!-- Campaign 3: New Product Launch (Ongoing - Amber Theme) -->
                    <div class="p-5 bg-yellow-50 rounded-xl border-2 border-status-warning shadow-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-extrabold text-status-warning">Campaign C: Product Launch (Current)</h3>
                            <span class="text-sm font-semibold text-white px-3 py-1 bg-status-warning rounded-full shadow-md">In Progress</span>
                        </div>
                        <p class="text-sm text-gray-700 mb-3">Goal: WhatsApp Orders. Currently 50% budget consumed.</p>
                        <div class="grid grid-cols-3 gap-3 text-center pt-3 border-t border-yellow-200">
                            <div><p class="text-2xl font-extrabold text-text-base">‚Çπ2,500</p><p class="text-xs text-gray-500">Total Spent</p></div>
                            <div><p class="text-2xl font-extrabold text-text-base">180</p><p class="text-xs text-gray-500">WhatsApp Leads</p></div>
                            <div><p class="text-2xl font-extrabold text-status-warning">‚Çπ14</p><p class="text-xs text-gray-500">Current CPA (Low)</p></div>
                        </div>
                    </div>

                    <div class="text-center pt-6">
                        <button onclick="navigate(5)" class="px-6 py-2 border border-primary-dark text-primary-dark font-semibold rounded-lg hover:bg-primary-dark/10 transition duration-150 shadow-md">
                            Back to Current Campaign Summary
                        </button>
                    </div>

                </div>
            `;
            updateUIControls();
        }

        // --- Initialization ---
        window.onload = () => {
            // Calculate initial expected outcomes based on default state
            calculateExpectedOutcomes();
            navigate(1);
        };
    </script>
</body>
</html>
