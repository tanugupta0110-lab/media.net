<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMB Smart Campaign Wizard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .step-container {
            display: none;
        }
        .ad-preview-box {
            min-height: 120px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 sm:p-6">
    <div id="app" class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transition-all duration-300">
        
        <!-- Header -->
        <header class="p-5 border-b border-gray-100 bg-white">
            <h1 class="text-xl font-bold text-gray-800">SMB Campaign Auto-Pilot</h1>
            <p class="text-sm text-gray-500 mt-1">Outcome-first ad wizard for local businesses.</p>
        </header>

        <!-- Main Content Area - Step Containers -->
        <div class="p-6 space-y-6">

            <!-- Step Indicator -->
            <div class="flex justify-between items-center text-xs font-medium text-center pb-2 border-b border-gray-100">
                <span id="step-1-indicator" class="text-blue-600">1. Persona</span>
                <span id="step-2-indicator" class="text-gray-400">2. Goal & Playbook</span>
                <span id="step-3-indicator" class="text-gray-400">3. Creative Studio</span>
                <span id="step-4-indicator" class="text-gray-400">4. Budget & Guardrails</span>
                <span id="step-5-indicator" class="text-gray-400">5. Dashboard</span>
            </div>
            
            <!-- STEP 1: Persona Selection -->
            <div id="step-1" class="step-container space-y-6 block">
                <h2 class="text-xl font-semibold text-gray-700">1. Tell us about your business.</h2>
                <div id="persona-summary" class="p-4 bg-yellow-50 text-yellow-800 rounded-lg text-sm hidden">
                    <p class="font-bold">Business Loaded:</p>
                    <p id="persona-details"></p>
                </div>
                
                <div class="space-y-4">
                    <button data-persona="sports" class="persona-btn w-full p-4 bg-white border border-gray-200 rounded-lg text-left hover:bg-blue-50 transition duration-150">
                        <p class="font-semibold text-gray-800">ðŸ‘Ÿ Sports Apparel / Gear</p>
                        <p class="text-sm text-gray-500">Footwear, outdoor gear, fitness services. (Focus: Walk-ins, Clearance).</p>
                    </button>
                    <button data-persona="jewelry" class="persona-btn w-full p-4 bg-white border border-gray-200 rounded-lg text-left hover:bg-blue-50 transition duration-150">
                        <p class="font-semibold text-gray-800">ðŸ’Ž Jewelry / Luxury Retail</p>
                        <p class="text-sm text-gray-500">High-value goods, focus on festivals and events. (Focus: Event RSVP, Calls).</p>
                    </button>
                </div>
                
                <button onclick="nextStep()" id="step-1-next" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 disabled:bg-blue-300" disabled>
                    Next: Pick Goal & Playbook
                </button>
            </div>

            <!-- STEP 2: Goal & Playbook -->
            <div id="step-2" class="step-container space-y-6">
                <h2 class="text-xl font-semibold text-gray-700">2. Goal & Campaign Playbook</h2>
                
                <div class="space-y-4">
                    <label for="goal-select" class="block text-sm font-medium text-gray-700">What is your primary goal?</label>
                    <select id="goal-select" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="walkins">ðŸš¶ Drive Walk-ins (Footfall)</option>
                        <option value="whatsapp">ðŸ’¬ Generate WhatsApp Orders/Chats</option>
                        <option value="calls">ðŸ“ž Get More Calls</option>
                        <option value="event">ðŸŽ« Promote an Event / RSVP</option>
                    </select>
                </div>

                <p class="text-sm text-gray-600 font-semibold">Recommended Playbooks for <span id="persona-name-step2" class="text-blue-600"></span>:</p>
                
                <div id="playbook-list" class="space-y-3">
                    <!-- Playbooks will be populated here -->
                </div>

                <div class="flex space-x-3">
                    <button onclick="prevStep()" class="flex-1 bg-gray-200 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">Back</button>
                    <button onclick="nextStep()" id="step-2-next" class="flex-1 bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150" disabled>
                        Next: Creative Studio
                    </button>
                </div>
            </div>

            <!-- STEP 3: Creative Studio Lite -->
            <div id="step-3" class="step-container space-y-6">
                <h2 class="text-xl font-semibold text-gray-700">3. Creative Studio Lite</h2>
                
                <div id="creative-info" class="p-3 bg-indigo-50 text-indigo-800 rounded-lg text-sm">
                    <!-- Playbook info here -->
                </div>

                <div class="space-y-4">
                    <label for="ad-copy" class="block text-sm font-medium text-gray-700">Ad Copy (Autofilled, Quick Edit)</label>
                    <textarea id="ad-copy" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 font-medium" maxlength="120"></textarea>
                    
                    <div class="flex justify-between items-center">
                        <label for="language-toggle" class="block text-sm font-medium text-gray-700">Language Toggle:</label>
                        <select id="language-toggle" class="p-2 border border-gray-300 rounded-lg text-sm">
                            <option value="en">English</option>
                            <option value="hi">Hinglish</option>
                        </select>
                    </div>

                    <label for="call-to-action" class="block text-sm font-medium text-gray-700">Call to Action (CTA)</label>
                    <select id="call-to-action" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="Call Now">ðŸ“ž Call Now</option>
                        <option value="Order on WhatsApp">ðŸ’¬ Order on WhatsApp</option>
                        <option value="Visit Store">ðŸš¶ Visit Store</option>
                        <option value="RSVP Now">ðŸŽ« RSVP Now</option>
                    </select>
                </div>

                <h3 class="text-lg font-semibold text-gray-700">Multi-Channel Preview</h3>
                <div id="ad-preview" class="ad-preview-box p-3 bg-white border border-gray-300">
                    <p class="text-sm text-gray-500">Google Search Preview</p>
                    <p id="preview-headline" class="text-base text-blue-600 font-bold mt-1 leading-tight"></p>
                    <p id="preview-description" class="text-sm text-gray-700 mt-1"></p>
                </div>
                
                <div class="flex space-x-3">
                    <button onclick="prevStep()" class="flex-1 bg-gray-200 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">Back</button>
                    <button onclick="nextStep()" class="flex-1 bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">
                        Next: Set Budget & Guardrails
                    </button>
                </div>
            </div>

            <!-- STEP 4: Budget & Guardrails -->
            <div id="step-4" class="step-container space-y-6">
                <h2 class="text-xl font-semibold text-gray-700">4. Budget & Guardrails</h2>
                
                <div class="space-y-2">
                    <label for="budget-slider" class="block text-sm font-medium text-gray-700">Daily Budget: <span id="budget-value" class="font-bold text-lg text-blue-600">â‚¹5,000</span></label>
                    <input type="range" id="budget-slider" min="2000" max="25000" step="1000" value="5000" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <h3 class="text-lg font-semibold text-gray-700 mt-6">Budget Confidence Simulator</h3>
                <div id="outcome-simulator" class="p-4 bg-green-50 rounded-lg border border-green-200">
                    <p class="text-sm text-gray-600">Expected Outcome for <span id="business-name-sim"></span>:</p>
                    <p class="text-3xl font-bold text-green-700 mt-2">
                        <span id="predicted-actions">~110</span> Actions
                    </p>
                    <p class="text-sm text-green-700 mt-1 font-medium">
                         (Est. CPA: â‚¹<span id="predicted-cpa">45</span> | <span id="sim-info">Higher volume, lower value actions.</span>)
                    </p>
                </div>

                <h3 class="text-lg font-semibold text-gray-700 mt-6">Safety Guardrails</h3>
                <div class="space-y-3">
                    <div class="flex items-start p-3 bg-white rounded-lg border border-gray-200">
                        <input type="checkbox" id="cpa-stop" class="mt-1 h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500" checked>
                        <div class="ml-3 text-sm">
                            <label for="cpa-stop" class="font-medium text-gray-700">Auto-Pause on High CPA</label>
                            <p class="text-gray-500">Stop campaign if Cost-per-Action exceeds â‚¹<span id="cpa-limit">100</span> (2x estimate).</p>
                        </div>
                    </div>
                    <div class="flex items-start p-3 bg-white rounded-lg border border-gray-200">
                        <input type="checkbox" id="auto-expiry" class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" checked>
                        <div class="ml-3 text-sm">
                            <label for="auto-expiry" class="font-medium text-gray-700">Auto-Expiry</label>
                            <p class="text-gray-500">Automatically stop campaign after 7 days (recommended for quick sales).</p>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-3 mt-6">
                    <button onclick="prevStep()" class="flex-1 bg-gray-200 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">Back</button>
                    <button onclick="publishCampaign()" class="flex-1 bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-150">
                        Publish Campaign Now
                    </button>
                </div>
            </div>

            <!-- STEP 5: Publish & Track -->
            <div id="step-5" class="step-container space-y-6 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-500 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                <h2 class="text-2xl font-bold text-gray-800">Campaign Launched!</h2>
                <p class="text-gray-600">Your <span id="published-playbook"></span> campaign for **<span id="published-persona"></span>** is live across Google & Meta.</p>
                
                <h3 class="text-xl font-semibold text-gray-700 pt-4">Mini Dashboard (Real-Time Mock)</h3>
                <div class="grid grid-cols-3 gap-3">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <p class="text-xs text-gray-600">Spend</p>
                        <p class="text-lg font-bold text-blue-700">â‚¹950</p>
                    </div>
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <p class="text-xs text-gray-600">Actions (Calls/DMs/QR)</p>
                        <p class="text-lg font-bold text-purple-700">18</p>
                    </div>
                    <div class="p-3 bg-green-100 rounded-lg">
                        <p class="text-xs text-gray-600">Avg. CPA</p>
                        <p class="text-lg font-bold text-green-700">â‚¹52.7</p>
                    </div>
                </div>
                <div class="p-3 bg-yellow-100 rounded-lg text-sm text-yellow-800 mt-4 font-medium">
                    "What Worked" Card: Top Action Hour was **6-7 PM** (Rainy-day Delivery).
                </div>
                
                <button onclick="window.location.reload()" class="mt-4 text-sm text-blue-600 font-semibold hover:underline">
                    Start a New Campaign
                </button>
            </div>

        </div>
    </div>

    <script type="module">
        // Global App State
        let campaignConfig = {
            step: 1,
            personaId: null,
            persona: null,
            selectedPlaybookId: null,
            goal: 'walkins',
            adCopy: '',
            cta: 'Visit Store',
            budget: 5000,
        };
        
        // --- FIREBASE MOCK SETUP (Environment Compliance) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // NOTE: setLogLevel is not exported from firebase-auth.js, removing to fix SyntaxError.
        
        let app, auth;
        
        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                // setLogLevel('Debug'); // Removing problematic call
            
                const signInPromise = typeof __initial_auth_token !== 'undefined' 
                    ? signInWithCustomToken(auth, __initial_auth_token)
                    : signInAnonymously(auth);
                    
                signInPromise.catch(e => console.error("Firebase Auth Error:", e));
            } else {
                console.warn("Firebase config missing. Running in mock-only mode.");
            }
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }
        
        // --- MOCK PERSONA & PLAYBOOK DATA ---

        const PERSONAS = {
            'sports': {
                name: 'The Runnerâ€™s Edge',
                type: 'Sports Apparel',
                locality: 'Jubilee Hills',
                phone: '+91 98765 43210',
                cpa_base: 50, // Low-value, high-volume actions
                sim_text: 'Higher volume, lower value actions (e.g., footfall, quick calls).',
                icon: 'ðŸ‘Ÿ'
            },
            'jewelry': {
                name: 'Heritage Jewels',
                type: 'Jewelry Retail',
                locality: 'Gachibowli',
                phone: '+91 99887 76655',
                cpa_base: 150, // High-value, low-volume actions
                sim_text: 'Lower volume, high-value actions (e.g., event RSVPs, detailed WhatsApp chats).',
                icon: 'ðŸ’Ž'
            }
        };

        const PLAYBOOKS = [
            { id: 'event-booster', name: 'Event Booster', icon: 'ðŸŽ«', 
              description: 'Promote an exclusive event or new collection launch with RSVP tracking.',
              copy_en: 'New Collection Preview: RSVP now for 10% off. {locality} store.',
              copy_hi: 'Naya Collection. RSVP karke 10% discount paayein. {locality} store.',
              keywords: ['event', 'luxury', 'festival', 'rsvp'], score_mod: 1.5, min_budget: 4000
            },
            { id: 'festival-sale', name: 'Festival Sale', icon: 'ðŸª”', 
              description: 'Drive urgency during peak season (Diwali, Wedding, etc.).',
              copy_en: 'Diwali offer: Get up to {discount}% off everything. Today only!',
              copy_hi: 'Diwali Dhamaka: Sab cheezon par {discount}% tak off. Aaj hi!',
              keywords: ['festival', 'clearance', 'luxury'], score_mod: 1.3, min_budget: 3000
            },
            { id: 'rainy-delivery', name: 'Rainy-day Delivery (Smart)', icon: 'â˜”', 
              description: 'Auto-schedules ads to push delivery/calls when rain is forecast.',
              copy_en: 'Rain outside? We deliver! Free shipping on all orders over â‚¹999.',
              copy_hi: 'Baarish aa rahi hai. Ghar baithe order karein. Free delivery!',
              keywords: ['weather', 'footins', 'whatsapp'], score_mod: 1.2, min_budget: 2000
            },
            { id: 'clearance', name: 'Clearance Sale', icon: 'ðŸ’¥', 
              description: 'Move older stock quickly with aggressive discounting for footfall.',
              copy_en: 'FINAL SALE: {discount}% off all last season stock. Visit now!',
              copy_hi: 'Aakhri sale! Pichle season ke stock par bhaari chhoot. Turant aayein!',
              keywords: ['clearance', 'footins', 'sports'], score_mod: 1.1, min_budget: 2000
            },
        ];

        // --- UI & NAVIGATION LOGIC ---

        function updateStepIndicator(currentStep) {
            for (let i = 1; i <= 5; i++) {
                const indicator = document.getElementById(`step-${i}-indicator`);
                if (indicator) {
                    indicator.classList.remove('text-blue-600', 'text-gray-400', 'font-bold', 'text-green-500');
                    if (i === currentStep) {
                        indicator.classList.add('text-blue-600', 'font-bold');
                    } else if (i < currentStep) {
                        indicator.classList.add('text-green-500', 'font-medium');
                    } else {
                        indicator.classList.add('text-gray-400', 'font-medium');
                    }
                }
            }
        }

        function showStep(step) {
            document.querySelectorAll('.step-container').forEach(el => el.style.display = 'none');
            const stepElement = document.getElementById(`step-${step}`);
            if (stepElement) {
                stepElement.style.display = 'block';
                campaignConfig.step = step;
                updateStepIndicator(step);
                
                // Call step-specific render functions
                if (step === 2) renderStep2();
                if (step === 3) renderStep3();
                if (step === 4) renderStep4();
                if (step === 5) renderStep5();
            }
        }

        function nextStep() {
            if (campaignConfig.step === 1) {
                if (!campaignConfig.personaId) return;
                showStep(2);
            } else if (campaignConfig.step === 2) {
                if (!campaignConfig.selectedPlaybookId) return;
                campaignConfig.goal = document.getElementById('goal-select').value;
                showStep(3);
            } else if (campaignConfig.step === 3) {
                campaignConfig.adCopy = document.getElementById('ad-copy').value;
                campaignConfig.cta = document.getElementById('call-to-action').value;
                showStep(4);
            } 
        }

        function prevStep() {
            if (campaignConfig.step > 1) {
                showStep(campaignConfig.step - 1);
            }
        }
        
        // --- STEP 1 LOGIC ---

        function initStep1() {
            document.querySelectorAll('.persona-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-persona');
                    selectPersona(id);
                });
            });
            // Pre-select for the demo
             selectPersona('sports');
        }

        function selectPersona(id) {
            campaignConfig.personaId = id;
            campaignConfig.persona = PERSONAS[id];
            
            // Highlight button
            document.querySelectorAll('.persona-btn').forEach(b => {
                b.classList.remove('ring-4', 'ring-blue-200', 'bg-blue-50');
            });
            document.querySelector(`.persona-btn[data-persona="${id}"]`).classList.add('ring-4', 'ring-blue-200', 'bg-blue-50');

            // Update summary
            document.getElementById('persona-details').innerHTML = `
                <p>Name: ${campaignConfig.persona.name}</p>
                <p>Location: ${campaignConfig.persona.locality}</p>
            `;
            document.getElementById('persona-summary').classList.remove('hidden');
            document.getElementById('step-1-next').disabled = false;
        }

        // --- STEP 2 LOGIC ---

        function calculatePlaybookScore(playbook, personaId) {
            let score = 100;
            const persona = PERSONAS[personaId];
            
            // Adjust score based on persona type affinity
            if (personaId === 'jewelry') {
                if (playbook.keywords.includes('luxury') || playbook.keywords.includes('festival')) score *= 1.5;
                if (playbook.keywords.includes('footins') || playbook.keywords.includes('clearance')) score *= 0.8;
            } else if (personaId === 'sports') {
                if (playbook.keywords.includes('sports') || playbook.keywords.includes('clearance')) score *= 1.5;
                if (playbook.keywords.includes('luxury') || playbook.keywords.includes('festival')) score *= 0.8;
            }

            // Adjust score based on Goal affinity (using the default 'walkins' for initial render)
            const goal = document.getElementById('goal-select').value;
            if (goal === 'event' && playbook.keywords.includes('rsvp')) score *= 2;
            if (goal === 'whatsapp' && playbook.keywords.includes('whatsapp')) score *= 1.5;
            if (goal === 'walkins' && playbook.keywords.includes('footins')) score *= 1.5;

            return Math.floor(score * playbook.score_mod);
        }

        function renderStep2() {
            document.getElementById('persona-name-step2').textContent = campaignConfig.persona.name;
            
            // Re-calculate scores and sort
            const rankedPlaybooks = PLAYBOOKS.map(pb => ({
                ...pb,
                score: calculatePlaybookScore(pb, campaignConfig.personaId)
            })).sort((a, b) => b.score - a.score);

            const playbookList = document.getElementById('playbook-list');
            playbookList.innerHTML = rankedPlaybooks.map(pb => {
                const isSelected = pb.id === campaignConfig.selectedPlaybookId;
                const isRecommended = pb === rankedPlaybooks[0];
                return `
                    <button data-id="${pb.id}" data-min-budget="${pb.min_budget}" class="playbook-btn w-full p-4 bg-white border ${isSelected ? 'border-indigo-500 ring-2 ring-indigo-200 bg-indigo-50' : 'border-gray-200'} rounded-lg text-left hover:bg-indigo-50 transition duration-150 relative">
                        ${isRecommended ? '<span class="absolute top-0 right-0 mt-[-10px] mr-[-10px] bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow-lg">TOP PICK</span>' : ''}
                        <p class="font-bold text-xl">${pb.icon} ${pb.name}</p>
                        <p class="text-sm text-gray-600 mt-1">${pb.description}</p>
                        <p class="text-xs text-gray-400 mt-2">Recommended Min. Budget: â‚¹${pb.min_budget.toLocaleString('en-IN')}</p>
                    </button>
                `;
            }).join('');

            document.querySelectorAll('.playbook-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.playbook-btn').forEach(b => {
                        b.classList.remove('border-indigo-500', 'ring-2', 'ring-indigo-200', 'bg-indigo-50');
                    });
                    this.classList.add('border-indigo-500', 'ring-2', 'ring-indigo-200', 'bg-indigo-50');
                    campaignConfig.selectedPlaybookId = this.getAttribute('data-id');
                    document.getElementById('step-2-next').disabled = false;
                    
                    // Set min budget for slider later
                    const minBudget = parseInt(this.getAttribute('data-min-budget'));
                    campaignConfig.budget = Math.max(campaignConfig.budget, minBudget);
                });
            });
            
            // Re-render and auto-select based on the new goal selection
            document.getElementById('goal-select').addEventListener('change', renderStep2);

            // Auto-select the top-ranked playbook
            if (rankedPlaybooks.length > 0) {
                 document.querySelector(`.playbook-btn[data-id="${rankedPlaybooks[0].id}"]`).click();
            }
        }
        
        // --- STEP 3 LOGIC ---
        
        function generateCopy(language, playbook, persona) {
            let copy = playbook[`copy_${language}`] || playbook.copy_en;
            
            // Dynamic Tokens
            copy = copy.replace('{locality}', persona.locality);
            
            // Persona-specific tokens (mocked values)
            let discount = '20';
            let product = 'Diamond Necklace';

            if (persona.type === 'Sports Apparel') {
                discount = '30';
                product = 'Running Shoes';
            }
            
            copy = copy.replace('{discount}', discount);
            copy = copy.replace('{product}', product);
            
            return copy;
        }

        function renderStep3() {
            const playbook = PLAYBOOKS.find(p => p.id === campaignConfig.selectedPlaybookId);
            const persona = campaignConfig.persona;
            
            document.getElementById('creative-info').innerHTML = `
                <p class="font-bold">Active Playbook: ${playbook.icon} ${playbook.name}</p>
                <p>Targets: ${persona.locality} radius, Auto-picks interests: ${playbook.keywords.join(', ')}</p>
            `;

            // Initial Copy Generation & Render
            const updateCreative = () => {
                const lang = document.getElementById('language-toggle').value;
                const copyText = generateCopy(lang, playbook, persona);
                
                document.getElementById('ad-copy').value = copyText;
                campaignConfig.adCopy = copyText;

                // Simple Preview Update
                const parts = copyText.split(':');
                document.getElementById('preview-headline').textContent = parts[0].trim().substring(0, 40) || 'Creative Headline';
                document.getElementById('preview-description').textContent = (parts.length > 1 ? parts[1].trim() : copyText.trim()).substring(0, 80) || 'Creative Description';
                
                document.getElementById('call-to-action').value = campaignConfig.goal === 'event' ? 'RSVP Now' : 'Visit Store';
            };

            document.getElementById('language-toggle').addEventListener('change', updateCreative);
            document.getElementById('ad-copy').addEventListener('input', updateCreative);
            
            updateCreative(); // Initial render
        }

        // --- STEP 4 LOGIC ---
        
        function simulateOutcome(budget, persona) {
            const actions = Math.floor(budget / persona.cpa_base);
            const predictedCPA = Math.floor(budget / actions);
            
            // Add a simulated confidence band based on budget size
            let uplift = 0;
            if (budget > 10000) uplift = 15;
            else if (budget > 5000) uplift = 10;
            
            const finalActions = Math.floor(actions * (1 + (uplift / 100)));

            return {
                actions: finalActions,
                cpa: predictedCPA,
                sim_text: persona.sim_text,
                cpa_stop_limit: persona.cpa_base * 2, // Guardrail rule
            };
        }

        function renderStep4() {
            const persona = campaignConfig.persona;
            const budgetSlider = document.getElementById('budget-slider');
            const budgetValue = document.getElementById('budget-value');
            
            document.getElementById('business-name-sim').textContent = persona.name;
            document.getElementById('cpa-limit').textContent = persona.cpa_base * 2;

            const updateSimulator = () => {
                const budget = parseInt(budgetSlider.value);
                campaignConfig.budget = budget;
                budgetValue.textContent = 'â‚¹' + budget.toLocaleString('en-IN');
                
                const outcome = simulateOutcome(budget, persona);
                
                document.getElementById('predicted-actions').textContent = `~${outcome.actions.toLocaleString()}`;
                document.getElementById('predicted-cpa').textContent = outcome.cpa;
                document.getElementById('sim-info').textContent = outcome.sim_text;
            };
            
            budgetSlider.addEventListener('input', updateSimulator);
            
            // Ensure slider starts at current budget or min if needed
            const currentPlaybook = PLAYBOOKS.find(p => p.id === campaignConfig.selectedPlaybookId);
            budgetSlider.min = currentPlaybook.min_budget;
            budgetSlider.value = Math.max(budgetSlider.value, currentPlaybook.min_budget);

            updateSimulator(); // Initial simulator render
        }

        // --- STEP 5 LOGIC (Dashboard) ---
        
        function renderStep5() {
            const playbook = PLAYBOOKS.find(p => p.id === campaignConfig.selectedPlaybookId);
            document.getElementById('published-persona').textContent = campaignConfig.persona.name;
            document.getElementById('published-playbook').textContent = playbook.name;
        }

        // --- APP INITIALIZATION ---

        window.onload = () => {
            initStep1();
            showStep(1);
        };

        function publishCampaign() {
             // Mock publish confirmation
             const isCpaStopOn = document.getElementById('cpa-stop').checked;
             const isExpiryOn = document.getElementById('auto-expiry').checked;

             const message = `
                 Publishing "${campaignConfig.persona.name}: ${PLAYBOOKS.find(p => p.id === campaignConfig.selectedPlaybookId).name}"
                 Budget: â‚¹${campaignConfig.budget.toLocaleString()}
                 Guardrails: CPA Stop (${isCpaStopOn ? 'ON' : 'OFF'}), Auto-Expiry (${isExpiryOn ? 'ON' : 'OFF'})
             `;
             console.log(message);
             showStep(5);
        }
    </script>
</body>
</html>
